---
title: detectFraud
$type: Function
name: detectFraud
description: Detect fraudulent transactions using ML patterns

input:
  transaction: Transaction details (object)
  userHistory: User transaction history (array)
  deviceFingerprint: Device fingerprint hash

output:
  isFraud: Fraud detected (bool)
  confidence: Confidence score 0-100 (number)
  riskFactors: Array of identified risk factors (array)
  recommendedAction: Action to take (allow, review, block)
---

# Detect Fraud Function

Real-time fraud detection using machine learning and rule-based patterns.

## Detection Methods

**Behavioral Analysis:**
- Unusual transaction amounts
- Rapid transaction frequency
- Location anomalies
- Device changes

**Pattern Matching:**
- Stolen card patterns
- Account takeover indicators
- Test transaction sequences
- Velocity checks

**Risk Factors:**
- High-risk geographies
- Mismatched billing addresses
- New payment methods
- VPN/proxy usage

## Usage

```yaml
function: detectFraud
input:
  transaction:
    amount: 50000
    currency: USD
    merchantCategory: electronics
    ipAddress: 192.168.1.100
    billingCountry: US
    shippingCountry: CN
  userHistory:
    - amount: 25
      date: 2024-10-01
    - amount: 45
      date: 2024-10-03
  deviceFingerprint: a1b2c3d4e5f6
output:
  isFraud: true
  confidence: 92
  riskFactors:
    - Amount 100x higher than average
    - First transaction over $100
    - Shipping to different country
    - New device fingerprint
  recommendedAction: block
```

## Related

- [[../workflows/processPayment|Process Payment Workflow]]
- [[assessRisk|Assess Risk Function]]

## Implementation

```typescript
import type { BusinessModule } from 'graphdl'

interface Transaction {
  amount: number
  currency: string
  merchantCategory: string
  ipAddress: string
  billingCountry: string
  shippingCountry: string
}

interface FraudDetectionResult {
  isFraud: boolean
  confidence: number
  riskFactors: string[]
  recommendedAction: 'allow' | 'review' | 'block'
}

/**
 * Detect Fraud Function - ML-powered transaction fraud detection
 *
 * Relationships:
 * - Used by Process Payment Workflow for real-time fraud checks
 * - Used by Order Processor Agent for order validation
 * - Combines rule-based patterns with ML anomaly detection
 */
export const detectFraud: BusinessModule = $ => {
  const { db, ai, api, send, on } = $

  async function performFraudDetection(
    transaction: Transaction,
    userHistory: Array<{ amount: number; date: Date }>,
    deviceFingerprint: string
  ): Promise<FraudDetectionResult> {
    const riskFactors: string[] = []
    let riskScore = 0

    // Calculate user's average transaction
    const avgAmount = userHistory.reduce((sum, tx) => sum + tx.amount, 0) / Math.max(1, userHistory.length)

    // Risk factor: Amount anomaly
    if (transaction.amount > avgAmount * 5) {
      riskFactors.push(`Amount ${Math.round(transaction.amount / avgAmount)}x higher than average`)
      riskScore += 30
    }

    // Risk factor: First high-value transaction
    const maxPrevious = Math.max(...userHistory.map(tx => tx.amount), 0)
    if (transaction.amount > 100 && maxPrevious < 100) {
      riskFactors.push('First transaction over $100')
      riskScore += 20
    }

    // Risk factor: Cross-country shipping
    if (transaction.billingCountry !== transaction.shippingCountry) {
      riskFactors.push('Shipping to different country')
      riskScore += 25
    }

    // Risk factor: New device
    const knownDevices = await db.devices.findMany({ userId: transaction.userId })
    if (!knownDevices.some(d => d.fingerprint === deviceFingerprint)) {
      riskFactors.push('New device fingerprint')
      riskScore += 15
    }

    // Risk factor: Velocity check
    const recentTransactions = userHistory.filter(
      tx => new Date().getTime() - tx.date.getTime() < 24 * 60 * 60 * 1000
    )
    if (recentTransactions.length >= 5) {
      riskFactors.push('High transaction velocity (5+ in 24h)')
      riskScore += 30
    }

    // AI-powered anomaly detection
    const mlScore = await ai.classify(
      `Transaction: ${JSON.stringify(transaction)}\nHistory: ${JSON.stringify(userHistory)}`,
      ['legitimate', 'suspicious', 'fraudulent']
    )

    if (mlScore === 'fraudulent') riskScore += 40
    if (mlScore === 'suspicious') riskScore += 20

    // Determine fraud status and action
    const confidence = Math.min(100, riskScore)
    const isFraud = confidence >= 70

    let recommendedAction: FraudDetectionResult['recommendedAction']
    if (confidence < 30) recommendedAction = 'allow'
    else if (confidence < 70) recommendedAction = 'review'
    else recommendedAction = 'block'

    return {
      isFraud,
      confidence,
      riskFactors,
      recommendedAction,
    }
  }

  on.function.completed(async event => {
    if (event.result.isFraud) {
      await send.slack('#fraud-alerts', `High-risk transaction detected: ${event.result.confidence}% confidence`)
    }

    await db.analytics.track({
      event: 'fraud_check_completed',
      isFraud: event.result.isFraud,
      confidence: event.result.confidence,
      timestamp: new Date(),
    })
  })

  return { detectFraud: performFraudDetection }
}
```
