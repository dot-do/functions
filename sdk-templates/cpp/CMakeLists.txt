# CMakeLists.txt for Functions.do C/C++ Module
# Generated by Functions.do
#
# Build instructions:
#   mkdir build && cd build
#   cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/emscripten.cmake -DCMAKE_BUILD_TYPE=Release ..
#   make
#
# For native testing:
#   mkdir build-native && cd build-native
#   cmake ..
#   make
#   ctest

cmake_minimum_required(VERSION 3.16)
project({{function_name}} LANGUAGES C CXX)

# Set C/C++ standards
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Include Functions.do helpers if using toolchain
if(CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
  # Define sources
  set(SOURCES
    src/main.c
  )

  # Define exports (function names without underscore prefix)
  set(EXPORTS
    add
    subtract
    multiply
    get_answer
  )

  # Create the WASM module using helper function
  functions_do_add_wasm_module(${PROJECT_NAME}
    SOURCES ${SOURCES}
    EXPORTS ${EXPORTS}
    OUTPUT_NAME ${PROJECT_NAME}
  )

  # Custom target for TypeScript bindings (generated by Functions.do)
  add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E echo "WASM module built: ${PROJECT_NAME}.wasm"
    COMMENT "Build complete. Deploy with: func deploy dist/"
  )
else()
  # Native build for testing
  message(STATUS "Building native executable for testing")

  add_executable(${PROJECT_NAME}_native
    src/main.c
  )

  target_compile_definitions(${PROJECT_NAME}_native PRIVATE
    FUNCTIONS_DO_NATIVE_TEST=1
  )

  # Enable testing
  enable_testing()
  add_test(NAME native_test COMMAND ${PROJECT_NAME}_native)
endif()

# Install rules for WASM module
if(CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
  install(FILES
    ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.wasm
    DESTINATION dist
  )
endif()

# Custom target for size report
add_custom_target(size
  COMMAND ${CMAKE_COMMAND} -E echo "WASM binary size:"
  COMMAND ls -lh ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.wasm 2>/dev/null || echo "Build first"
  DEPENDS ${PROJECT_NAME}
)

# Custom target for running wasm-opt
add_custom_target(optimize
  COMMAND wasm-opt -Oz -o ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.opt.wasm ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.wasm
  COMMAND ${CMAKE_COMMAND} -E echo "Optimized: ${PROJECT_NAME}.opt.wasm"
  COMMAND ls -lh ${CMAKE_BINARY_DIR}/${PROJECT_NAME}.opt.wasm
  DEPENDS ${PROJECT_NAME}
)
