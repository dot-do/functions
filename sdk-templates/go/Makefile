# Makefile for Functions.do Go WASM module
# Target output size: 100KB - 2MB

# TinyGo settings for minimal binary size
TINYGO = tinygo
TARGET = wasi
OPT_LEVEL = s
EXTRA_FLAGS = -no-debug -gc=leaking -scheduler=none

# Module name (change this for your module)
MODULE_NAME = example

# Output files
OUT_DIR = dist
WASM_FILE = $(OUT_DIR)/$(MODULE_NAME).wasm
WASM_OPT_FILE = $(OUT_DIR)/$(MODULE_NAME).opt.wasm

# Source files
SRC = main.go

.PHONY: all build clean size check-tinygo optimize

all: build

check-tinygo:
	@which $(TINYGO) > /dev/null || (echo "TinyGo not found. Install from https://tinygo.org" && exit 1)

build: check-tinygo
	@mkdir -p $(OUT_DIR)
	$(TINYGO) build \
		-o $(WASM_FILE) \
		-target=$(TARGET) \
		-opt=$(OPT_LEVEL) \
		$(EXTRA_FLAGS) \
		$(SRC)
	@echo "Built: $(WASM_FILE)"
	@make size

# Build with debug symbols (larger but debuggable)
build-debug: check-tinygo
	@mkdir -p $(OUT_DIR)
	$(TINYGO) build \
		-o $(WASM_FILE) \
		-target=$(TARGET) \
		-opt=0 \
		$(SRC)
	@echo "Built (debug): $(WASM_FILE)"
	@make size

# Further optimize with wasm-opt if available
optimize: build
	@which wasm-opt > /dev/null && \
		wasm-opt -Os --strip-debug -o $(WASM_OPT_FILE) $(WASM_FILE) && \
		echo "Optimized: $(WASM_OPT_FILE)" && \
		ls -lh $(WASM_OPT_FILE) || \
		echo "wasm-opt not found, skipping optimization"

size:
	@echo "WASM binary size:"
	@ls -lh $(WASM_FILE) | awk '{print $$5, $$9}'
	@SIZE=$$(stat -f%z $(WASM_FILE) 2>/dev/null || stat -c%s $(WASM_FILE) 2>/dev/null); \
		if [ $$SIZE -lt 102400 ]; then \
			echo "Size: $$SIZE bytes (under 100KB target - excellent!)"; \
		elif [ $$SIZE -lt 2097152 ]; then \
			echo "Size: $$SIZE bytes (within 100KB-2MB target)"; \
		else \
			echo "WARNING: Size $$SIZE bytes exceeds 2MB target!"; \
		fi

clean:
	rm -rf $(OUT_DIR)

# Development helpers
.PHONY: watch test lint

watch:
	@echo "Watching for changes..."
	@while true; do \
		inotifywait -qq -e modify $(SRC) 2>/dev/null || fswatch -1 $(SRC) 2>/dev/null; \
		make build; \
	done

test: build
	@echo "Testing WASM module..."
	@node -e "\
		const fs = require('fs'); \
		const wasm = fs.readFileSync('$(WASM_FILE)'); \
		WebAssembly.instantiate(wasm).then(m => { \
			const exports = m.instance.exports; \
			console.log('Exports:', Object.keys(exports)); \
			if (exports.add) console.log('add(2, 3) =', exports.add(2, 3)); \
			if (exports.multiply) console.log('multiply(6, 7) =', exports.multiply(6, 7)); \
			if (exports.get_answer) console.log('get_answer() =', exports.get_answer()); \
		})"

lint:
	@echo "Linting Go code..."
	@gofmt -l -w $(SRC)
	@go vet $(SRC) 2>/dev/null || echo "go vet not available"

# Generate TypeScript bindings
.PHONY: generate-bindings

generate-bindings:
	@echo "TypeScript bindings should be generated by Functions.do platform"
	@echo "See bindings.ts and types.d.ts for examples"

# Help target
.PHONY: help

help:
	@echo "Functions.do Go WASM Module"
	@echo ""
	@echo "Targets:"
	@echo "  build          - Build WASM module (optimized for size)"
	@echo "  build-debug    - Build WASM module (with debug symbols)"
	@echo "  optimize       - Further optimize with wasm-opt"
	@echo "  size           - Show WASM binary size"
	@echo "  test           - Test WASM module with Node.js"
	@echo "  clean          - Remove build artifacts"
	@echo "  watch          - Rebuild on file changes"
	@echo "  lint           - Format and lint Go code"
	@echo "  help           - Show this help message"
